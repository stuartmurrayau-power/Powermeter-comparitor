<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIT Power Analyser</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #080a0f;
  --bg2:      #0d1017;
  --surface:  #111520;
  --surface2: #161b28;
  --surface3: #1c2335;
  --border:   #1e2840;
  --border2:  #263350;
  --green:    #00ff87;
  --green2:   #00cc6a;
  --pink:     #ff3d7f;
  --pink2:    #cc2060;
  --yellow:   #ffd23f;
  --blue:     #3d8bff;
  --text:     #dde4f0;
  --text2:    #8a9bb8;
  --text3:    #4a5878;
  --accent:   #3d8bff;
  --mono:     'JetBrains Mono', monospace;
  --display:  'Barlow Condensed', sans-serif;
}

html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ── Noise overlay ── */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* ── Grid lines bg ── */
body::after {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  opacity: 0.03;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 40px 40px;
}

.page { position: relative; z-index: 1; }

/* ══════════════════════════════════
   TOP NAV
══════════════════════════════════ */
.nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 32px;
  border-bottom: 1px solid var(--border);
  background: rgba(8,10,15,0.9);
  backdrop-filter: blur(12px);
  position: sticky; top: 0; z-index: 100;
}

.nav-brand {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--display);
  font-size: 1.3rem;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text);
}

.nav-brand .dot {
  width: 8px; height: 8px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--green);
  animation: breathe 2s ease-in-out infinite;
}
@keyframes breathe {
  0%,100% { opacity:1; box-shadow: 0 0 8px var(--green); }
  50%      { opacity:0.5; box-shadow: 0 0 2px var(--green); }
}

.nav-meta {
  font-size: 0.65rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

/* ══════════════════════════════════
   UPLOAD SCREEN
══════════════════════════════════ */
#upload-screen {
  min-height: calc(100vh - 57px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 32px;
  gap: 48px;
}

.upload-hero {
  text-align: center;
  max-width: 560px;
}

.upload-hero h2 {
  font-family: var(--display);
  font-size: clamp(2.4rem, 5vw, 3.8rem);
  font-weight: 800;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  line-height: 1;
  color: var(--text);
  margin-bottom: 14px;
}

.upload-hero h2 span { color: var(--green); }

.upload-hero p {
  color: var(--text2);
  font-size: 0.82rem;
  line-height: 1.7;
  letter-spacing: 0.02em;
}

.upload-panels {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 0;
  align-items: stretch;
  width: 100%;
  max-width: 820px;
}

.upload-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  color: var(--text3);
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  writing-mode: vertical-rl;
  gap: 8px;
}

.upload-divider::before,
.upload-divider::after {
  content: '';
  flex: 1;
  width: 1px;
  background: var(--border);
}

.drop-zone {
  border: 1px solid var(--border2);
  border-radius: 12px;
  background: var(--surface);
  padding: 40px 28px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  min-height: 260px;
  justify-content: center;
}

.drop-zone::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 50% 0%, rgba(0,255,135,0.04) 0%, transparent 70%);
  pointer-events: none;
  transition: opacity 0.3s;
}

.drop-zone.device-2::before {
  background: radial-gradient(ellipse at 50% 0%, rgba(255,61,127,0.04) 0%, transparent 70%);
}

.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--green);
  background: var(--surface2);
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0,255,135,0.08);
}

.drop-zone.device-2:hover, .drop-zone.device-2.dragover {
  border-color: var(--pink);
  box-shadow: 0 8px 32px rgba(255,61,127,0.08);
}

.drop-zone.loaded {
  border-color: var(--green);
  background: var(--surface2);
}

.drop-zone.device-2.loaded {
  border-color: var(--pink);
}

.drop-icon {
  width: 52px; height: 52px;
  border-radius: 10px;
  background: var(--surface3);
  border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  transition: all 0.2s;
}

.drop-zone:hover .drop-icon, .drop-zone.loaded .drop-icon {
  background: rgba(0,255,135,0.1);
  border-color: var(--green);
}

.drop-zone.device-2:hover .drop-icon, .drop-zone.device-2.loaded .drop-icon {
  background: rgba(255,61,127,0.1);
  border-color: var(--pink);
}

.drop-label {
  font-family: var(--display);
  font-size: 0.9rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text2);
}

.drop-device-tag {
  font-family: var(--display);
  font-size: 1.5rem;
  font-weight: 800;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--green);
}

.drop-zone.device-2 .drop-device-tag { color: var(--pink); }

.drop-sub {
  font-size: 0.68rem;
  color: var(--text3);
  text-align: center;
  line-height: 1.6;
  letter-spacing: 0.04em;
}

.drop-filename {
  font-size: 0.72rem;
  color: var(--green);
  font-weight: 500;
  text-align: center;
  word-break: break-all;
  padding: 6px 12px;
  background: rgba(0,255,135,0.08);
  border-radius: 6px;
  border: 1px solid rgba(0,255,135,0.2);
  display: none;
}

.drop-zone.device-2 .drop-filename {
  color: var(--pink);
  background: rgba(255,61,127,0.08);
  border-color: rgba(255,61,127,0.2);
}

.drop-zone.loaded .drop-filename { display: block; }
.drop-zone.loaded .drop-sub { display: none; }

input[type="file"] { display: none; }

/* Interval config */
.config-row {
  display: flex;
  align-items: center;
  gap: 24px;
  flex-wrap: wrap;
  justify-content: center;
}

.config-field {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 10px 16px;
}

.config-label {
  font-size: 0.68rem;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}

.config-select, .config-input {
  background: var(--surface3);
  border: 1px solid var(--border2);
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.8rem;
  padding: 4px 10px;
  border-radius: 6px;
  outline: none;
  cursor: pointer;
}

.config-select:focus, .config-input:focus {
  border-color: var(--accent);
}

.config-input { width: 70px; text-align: center; }

/* Analyse button */
.btn-analyse {
  font-family: var(--display);
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  background: var(--green);
  color: var(--bg);
  border: none;
  border-radius: 10px;
  padding: 14px 48px;
  cursor: pointer;
  transition: all 0.2s;
  opacity: 0.4;
  pointer-events: none;
}

.btn-analyse.ready {
  opacity: 1;
  pointer-events: all;
  box-shadow: 0 4px 24px rgba(0,255,135,0.25);
}

.btn-analyse.ready:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0,255,135,0.35);
}

/* ══════════════════════════════════
   PROCESSING
══════════════════════════════════ */
#processing-screen {
  display: none;
  min-height: calc(100vh - 57px);
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 60px;
}

.processing-spinner {
  width: 48px; height: 48px;
  border: 2px solid var(--border2);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.processing-label {
  font-family: var(--display);
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text2);
}

.processing-step {
  font-size: 0.72rem;
  color: var(--text3);
  letter-spacing: 0.08em;
}

/* ══════════════════════════════════
   DASHBOARD
══════════════════════════════════ */
#dashboard-screen {
  display: none;
  padding: 32px;
  max-width: 1400px;
  margin: 0 auto;
}

.dash-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 16px;
}

.dash-title {
  font-family: var(--display);
  font-size: clamp(1.8rem, 3vw, 2.6rem);
  font-weight: 800;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  line-height: 1;
}

.dash-subtitle {
  color: var(--text2);
  font-size: 0.72rem;
  margin-top: 8px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 0.62rem;
  padding: 3px 10px;
  border-radius: 20px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  vertical-align: middle;
  margin-left: 10px;
}

.badge-green {
  background: rgba(0,255,135,0.1);
  border: 1px solid rgba(0,255,135,0.25);
  color: var(--green);
}

.badge-yellow {
  background: rgba(255,210,63,0.1);
  border: 1px solid rgba(255,210,63,0.25);
  color: var(--yellow);
}

.dash-right {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.legend-row {
  display: flex;
  gap: 20px;
  align-items: center;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.7rem;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.swatch { width: 24px; height: 2px; border-radius: 2px; }

.btn-reset {
  font-family: var(--display);
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: transparent;
  color: var(--text3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-reset:hover {
  color: var(--text);
  border-color: var(--text3);
}

/* Stats grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 18px;
  transition: border-color 0.2s;
}

.stat-card:hover { border-color: var(--border2); }

.stat-label {
  font-size: 0.62rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 6px;
}

.stat-value {
  font-family: var(--display);
  font-size: 1.6rem;
  font-weight: 700;
  line-height: 1;
}

.stat-sub {
  font-size: 0.62rem;
  color: var(--text3);
  margin-top: 4px;
}

/* Zoom stats banner */
.zoom-banner-wrap { margin-bottom: 8px; }

.zoom-badge-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.live-dot {
  width: 6px; height: 6px;
  background: var(--accent);
  border-radius: 50%;
  animation: breathe 1.5s infinite;
  box-shadow: 0 0 6px var(--accent);
}

.zoom-label {
  font-size: 0.65rem;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.zoom-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.zoom-stat {
  background: var(--surface2);
  padding: 11px 16px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.zoom-stat-label {
  font-size: 0.6rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.zoom-stat-value {
  font-family: var(--display);
  font-size: 1.3rem;
  font-weight: 700;
  line-height: 1;
  transition: color 0.15s;
}

.zoom-stat-sub {
  font-size: 0.6rem;
  color: var(--text3);
}

/* Chart containers */
.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 16px;
}

.chart-card-label {
  font-size: 0.62rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  margin-bottom: 12px;
}

.chart-hint {
  font-size: 0.62rem;
  color: var(--text3);
  text-align: center;
  margin-top: 10px;
  letter-spacing: 0.06em;
}

/* Interval table */
.table-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
}

.table-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
  flex-wrap: wrap;
  gap: 10px;
}

.table-header-label {
  font-size: 0.62rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.table-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.interval-config {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.65rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.interval-config input {
  width: 60px;
  background: var(--surface3);
  border: 1px solid var(--border2);
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 5px;
  text-align: center;
  outline: none;
}

.interval-config input:focus { border-color: var(--accent); }

.interval-config select {
  background: var(--surface3);
  border: 1px solid var(--border2);
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.72rem;
  padding: 3px 8px;
  border-radius: 5px;
  outline: none;
  cursor: pointer;
}

.interval-config select:focus { border-color: var(--accent); }

.btn-apply {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: rgba(61,139,255,0.12);
  color: var(--accent);
  border: 1px solid rgba(61,139,255,0.25);
  border-radius: 6px;
  padding: 4px 12px;
  cursor: pointer;
  transition: all 0.15s;
}

.btn-apply:hover { background: rgba(61,139,255,0.2); }

.pagination {
  display: flex;
  align-items: center;
  gap: 8px;
}

.page-btn {
  background: var(--surface3);
  border: 1px solid var(--border2);
  color: var(--text2);
  font-family: var(--mono);
  font-size: 0.68rem;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
}

.page-btn:hover:not(:disabled) {
  border-color: var(--accent);
  color: var(--accent);
}

.page-btn:disabled { opacity: 0.3; cursor: default; }
.page-info { font-size: 0.65rem; color: var(--text3); min-width: 80px; text-align: center; }

table { width: 100%; border-collapse: collapse; font-size: 0.76rem; }
th {
  background: var(--surface2);
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 0.6rem;
  padding: 10px 16px;
  text-align: right;
  font-weight: 400;
  border-bottom: 1px solid var(--border);
}
th:first-child { text-align: left; }
td {
  padding: 9px 16px;
  text-align: right;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
}
td:first-child { text-align: left; color: var(--text); font-size: 0.72rem; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); }

.val-green { color: var(--green) !important; font-weight: 500; }
.val-pink  { color: var(--pink)  !important; font-weight: 500; }
.val-pos   { color: var(--pink)  !important; font-weight: 500; }
.val-neg   { color: var(--green) !important; font-weight: 500; }

.tag-partial {
  display: inline-block;
  background: rgba(255,210,63,0.1);
  color: var(--yellow);
  border: 1px solid rgba(255,210,63,0.2);
  font-size: 0.55rem;
  padding: 1px 5px;
  border-radius: 4px;
  vertical-align: middle;
  margin-left: 5px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* ── Notes field ── */
.notes-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 16px;
}

.notes-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.notes-card-label {
  font-size: 0.62rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

.notes-char-count {
  font-size: 0.6rem;
  color: var(--text3);
  letter-spacing: 0.06em;
}

.notes-textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.8rem;
  line-height: 1.6;
  padding: 12px 14px;
  resize: vertical;
  min-height: 90px;
  outline: none;
  transition: border-color 0.2s;
  letter-spacing: 0.02em;
}

.notes-textarea::placeholder { color: var(--text3); }
.notes-textarea:focus { border-color: var(--border2); box-shadow: 0 0 0 2px rgba(61,139,255,0.12); }

/* ── Save button ── */
.btn-save {
  font-family: var(--display);
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: rgba(0,255,135,0.1);
  color: var(--green);
  border: 1px solid rgba(0,255,135,0.25);
  border-radius: 8px;
  padding: 8px 18px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-save:hover {
  background: rgba(0,255,135,0.18);
  border-color: rgba(0,255,135,0.45);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0,255,135,0.15);
}

.btn-save:active { transform: translateY(0); }

.btn-save.saving {
  opacity: 0.6;
  pointer-events: none;
}

/* ── Save success toast ── */
.save-toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: #0a1a12;
  border: 1px solid rgba(0,255,135,0.3);
  border-radius: 10px;
  padding: 14px 20px;
  color: var(--green);
  font-size: 0.75rem;
  z-index: 1000;
  display: none;
  animation: slideUp 0.3s ease;
}

/* Error toast */
.error-toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: #1a0a0a;
  border: 1px solid #ff3d3d44;
  border-radius: 10px;
  padding: 14px 20px;
  color: #ff6b6b;
  font-size: 0.75rem;
  max-width: 340px;
  z-index: 1000;
  display: none;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { opacity:0; transform:translateY(8px); } }

@media (max-width: 700px) {
  .upload-panels { grid-template-columns: 1fr; }
  .upload-divider { writing-mode: initial; width: auto; height: 40px; flex-direction: row; }
  .zoom-stats { grid-template-columns: repeat(2, 1fr); }
  #dashboard-screen { padding: 16px; }
}
</style>
</head>
<body>
<div class="page">

<!-- ── NAV ── -->
<nav class="nav">
  <div class="nav-brand">
    <span class="dot"></span>
    FIT Power Analyser
  </div>
  <span class="nav-meta">Client-side &middot; No data uploaded &middot; .fit files only</span>
</nav>

<!-- ══════════════════════════════════
     UPLOAD SCREEN
══════════════════════════════════ -->
<div id="upload-screen">

  <div class="upload-hero">
    <h2>Compare <span>Power</span> Meters</h2>
    <p>Drop two .fit files recorded simultaneously on different power meters.
       Everything is processed locally in your browser — no data ever leaves your device.</p>
  </div>

  <div class="upload-panels">

    <!-- Device 1 -->
    <div class="drop-zone" id="dz1" onclick="document.getElementById('fi1').click()">
      <input type="file" id="fi1" accept=".fit" onchange="handleFile(this,1)">
      <div class="drop-icon">⚡</div>
      <div class="drop-device-tag">Device 1</div>
      <div class="drop-label">Drop .fit file here</div>
      <div class="drop-sub">or click to browse<br>Powertap, Garmin, Wahoo…</div>
      <div class="drop-filename" id="fn1"></div>
    </div>

    <div class="upload-divider">vs</div>

    <!-- Device 2 -->
    <div class="drop-zone device-2" id="dz2" onclick="document.getElementById('fi2').click()">
      <input type="file" id="fi2" accept=".fit" onchange="handleFile(this,2)">
      <div class="drop-icon">⚡</div>
      <div class="drop-device-tag">Device 2</div>
      <div class="drop-label">Drop .fit file here</div>
      <div class="drop-sub">or click to browse<br>Xcadey, 4iiii, Stages…</div>
      <div class="drop-filename" id="fn2"></div>
    </div>

  </div>

  <!-- Interval config -->
  <div class="config-row">
    <div class="config-field">
      <span class="config-label">Interval Size</span>
      <input type="number" class="config-input" id="interval-value" value="15" min="1" max="9999">
      <select class="config-select" id="interval-unit">
        <option value="seconds">seconds</option>
        <option value="minutes" selected>minutes</option>
      </select>
    </div>
  </div>

  <button class="btn-analyse" id="btn-analyse" onclick="runAnalysis()">
    Analyse Ride →
  </button>

</div>

<!-- ══════════════════════════════════
     PROCESSING
══════════════════════════════════ -->
<div id="processing-screen" style="display:none; min-height:calc(100vh - 57px); flex-direction:column; align-items:center; justify-content:center; gap:20px;">
  <div class="processing-spinner"></div>
  <div class="processing-label">Parsing .fit files</div>
  <div class="processing-step" id="processing-step">Reading binary data…</div>
</div>

<!-- ══════════════════════════════════
     DASHBOARD
══════════════════════════════════ -->
<div id="dashboard-screen">

  <div class="dash-header">
    <div>
      <div class="dash-title" id="dash-title">—</div>
      <div class="dash-subtitle" id="dash-subtitle">—</div>
    </div>
    <div class="dash-right">
      <div class="legend-row">
        <div class="legend-item">
          <div class="swatch" style="background:var(--green)"></div>
          <span id="leg1">Device 1</span>
        </div>
        <div class="legend-item">
          <div class="swatch" style="background:var(--pink)"></div>
          <span id="leg2">Device 2</span>
        </div>
      </div>
      <button class="btn-save" id="btn-save" onclick="saveReport()">
        <svg width="13" height="13" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.5 13H2.5C1.948 13 1.5 12.552 1.5 12V2C1.5 1.448 1.948 1 2.5 1H9.5L12.5 4V12C12.5 12.552 12.052 13 11.5 13Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 13V8.5H4.5V13" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.5 1V4.5H8.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Save Report
      </button>
      <button class="btn-reset" onclick="resetApp()">↩ Analyse Another Ride</button>
    </div>
  </div>

  <!-- Summary stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label" id="sc1-label">Device 1 Avg Power</div>
      <div class="stat-value" style="color:var(--green)" id="sc1-val">—</div>
      <div class="stat-sub">Full ride (excl. zeros)</div>
    </div>
    <div class="stat-card">
      <div class="stat-label" id="sc2-label">Device 2 Avg Power</div>
      <div class="stat-value" style="color:var(--pink)" id="sc2-val">—</div>
      <div class="stat-sub">Full ride (excl. zeros)</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Difference (Dev2 − Dev1)</div>
      <div class="stat-value" id="sc3-val">—</div>
      <div class="stat-sub" id="sc3-sub">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Ride Duration</div>
      <div class="stat-value" style="color:var(--blue)" id="sc4-val">—</div>
      <div class="stat-sub" id="sc4-sub">—</div>
    </div>
  </div>

  <!-- Live zoom stats -->
  <div class="zoom-banner-wrap">
    <div class="zoom-badge-row">
      <div class="live-dot"></div>
      <div class="zoom-label">Live — <span id="zoom-range-label">Full ride</span></div>
    </div>
    <div class="zoom-stats">
      <div class="zoom-stat">
        <div class="zoom-stat-label" id="zsl-label">Dev 1 Avg</div>
        <div class="zoom-stat-value" style="color:var(--green)" id="zs-d1">—</div>
        <div class="zoom-stat-sub" id="zs-d1-sub">—</div>
      </div>
      <div class="zoom-stat">
        <div class="zoom-stat-label" id="zs2-label">Dev 2 Avg</div>
        <div class="zoom-stat-value" style="color:var(--pink)" id="zs-d2">—</div>
        <div class="zoom-stat-sub" id="zs-d2-sub">—</div>
      </div>
      <div class="zoom-stat">
        <div class="zoom-stat-label">Difference (D2 − D1)</div>
        <div class="zoom-stat-value" id="zs-diff">—</div>
        <div class="zoom-stat-sub" id="zs-diff-sub">—</div>
      </div>
      <div class="zoom-stat">
        <div class="zoom-stat-label">Points in View</div>
        <div class="zoom-stat-value" style="color:var(--blue)" id="zs-pts">—</div>
        <div class="zoom-stat-sub" id="zs-time-range">—</div>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="notes-card">
    <div class="notes-card-header">
      <span class="notes-card-label">Ride Notes &amp; Observations</span>
      <span class="notes-char-count" id="notes-count">0 chars</span>
    </div>
    <textarea class="notes-textarea" id="ride-notes" placeholder="Add notes about this ride — conditions, observations, calibration details, how the devices compared…" maxlength="4000" oninput="updateNotesCount()"></textarea>
  </div>

  <!-- Main chart -->
  <div class="chart-card">
    <div class="chart-card-label">Power Output — zoom &amp; pan to interrogate</div>
    <div id="main-chart"></div>
    <div class="chart-hint">&#9635; Box-select to zoom &middot; Scroll to zoom &middot; Click legend to toggle &middot; Double-click to reset</div>
  </div>

  <!-- Diff chart -->
  <div class="chart-card">
    <div class="chart-card-label" id="diff-chart-label">Power Difference (Device 2 − Device 1)</div>
    <div id="diff-chart"></div>
  </div>

  <!-- Interval table -->
  <div class="table-card">
    <div class="table-header">
      <span class="table-header-label">Interval Summary</span>
      <div class="table-controls">
        <div class="interval-config">
          <span>Interval:</span>
          <input type="number" id="tbl-interval-val" value="15" min="1" max="9999">
          <select id="tbl-interval-unit">
            <option value="seconds">sec</option>
            <option value="minutes" selected>min</option>
          </select>
          <button class="btn-apply" onclick="rebuildTable()">Apply</button>
        </div>
        <div class="pagination">
          <button class="page-btn" id="btn-prev" onclick="changePage(-1)" disabled>← Prev</button>
          <span class="page-info" id="page-info">Page 1</span>
          <button class="page-btn" id="btn-next" onclick="changePage(1)">Next →</button>
        </div>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th id="th-interval">Interval</th>
          <th id="th-d1">Device 1 Avg (W)</th>
          <th id="th-d2">Device 2 Avg (W)</th>
          <th>Difference (W)</th>
        </tr>
      </thead>
      <tbody id="interval-tbody"></tbody>
    </table>
  </div>

</div><!-- /dashboard -->

</div><!-- /page -->

<div class="error-toast" id="error-toast"></div>
<div class="save-toast" id="save-toast">✓ Report saved — check your Downloads folder</div>

<!-- ══════════════════════════════════
     SCRIPTS
══════════════════════════════════ -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
(function () {
'use strict';

// ── State ──────────────────────────────────────────────────────────
var state = {
  file1: null, file2: null,
  data1: null, data2: null,
  aligned: null,
  chartData: null,
  intervals: [],
  currentPage: 0,
  totalDuration: 0,
  dev1Name: 'Device 1',
  dev2Name: 'Device 2',
  pauseDetected: false,
  pauseRegions: []
};

var PAGE_SIZE = 30;

// ── Manufacturer lookup ────────────────────────────────────────────
var MFR = {
  1:'Garmin', 32:'Wahoo', 40:'SRM', 76:'4iiii',
  89:'PowerTap', 115:'Garmin/PowerTap', 116:'Tacx',
  255:'Development', 294:'Xcadey', 630:'PowerTap', 2067:'Xcadey'
};

// ── FIT base types ─────────────────────────────────────────────────
var BT = {
  0x00:[1,'uint'], 0x01:[1,'sint'], 0x02:[1,'uint'],
  0x83:[2,'sint'], 0x84:[2,'uint'],
  0x85:[4,'sint'], 0x86:[4,'uint'],
  0x07:[1,'str'],
  0x88:[4,'f32'], 0x89:[8,'f64'],
  0x0A:[1,'uint'], 0x8B:[2,'uint'], 0x8C:[4,'uint'],
  0x0D:[1,'uint'], 0x8E:[8,'sint'], 0x8F:[8,'uint'], 0x90:[8,'uint']
};

var INVALID = { 1:0xFF, 2:0xFFFF, 4:0xFFFFFFFF };

function readVal(dv, offset, fsize, ftype, little) {
  var bt = BT[ftype];
  if (!bt) return null;
  var sz = bt[0], kind = bt[1];
  if (kind === 'str') {
    var bytes = [];
    for (var i=0; i<fsize; i++) bytes.push(dv.getUint8(offset+i));
    return String.fromCharCode.apply(null, bytes).replace(/\0/g,'');
  }
  if (fsize !== sz) return null;
  var val;
  try {
    if (kind==='uint') {
      if (sz===1) val=dv.getUint8(offset);
      else if (sz===2) val=dv.getUint16(offset,little);
      else if (sz===4) val=dv.getUint32(offset,little);
      else val=null; // uint64 — skip
    } else if (kind==='sint') {
      if (sz===1) val=dv.getInt8(offset);
      else if (sz===2) val=dv.getInt16(offset,little);
      else if (sz===4) val=dv.getInt32(offset,little);
      else val=null;
    } else if (kind==='f32') {
      val=dv.getFloat32(offset,little);
    } else if (kind==='f64') {
      val=dv.getFloat64(offset,little);
    }
  } catch(e) { val=null; }
  var inv = INVALID[sz];
  if (inv !== undefined && val === inv) return null;
  return val;
}

// ── FIT parser ─────────────────────────────────────────────────────
function parseFIT(buffer) {
  var u8 = new Uint8Array(buffer);
  var dv = new DataView(buffer);
  var hdrSize = u8[0];
  var pos = hdrSize;
  var defs = {};
  var records = [];
  var fileInfo = {}, deviceInfo = {};

  while (pos < u8.length - 2) {
    if (pos >= u8.length) break;
    var hdr = u8[pos++];

    // Compressed timestamp
    if (hdr & 0x80) {
      var ln0 = (hdr >> 5) & 0x03;
      if (defs[ln0]) {
        var def0 = defs[ln0];
        var row0 = {};
        for (var fi=0; fi<def0.fields.length; fi++) {
          var f=def0.fields[fi];
          if (pos+f.size > u8.length) break;
          row0[f.num] = readVal(dv, pos, f.size, f.type, def0.little);
          pos += f.size;
        }
        if (def0.gnum === 20) records.push(row0);
      }
      continue;
    }

    var isDef   = (hdr >> 6) & 0x01;
    var hasDev  = isDef ? (hdr >> 5) & 0x01 : 0;
    var localNum = hdr & 0x0F;

    if (isDef) {
      pos++; // reserved
      var arch = u8[pos++];
      var little = arch === 0;
      var gnum = little ? dv.getUint16(pos,true) : dv.getUint16(pos,false);
      pos += 2;
      var nFields = u8[pos++];
      var fields = [];
      for (var i=0; i<nFields; i++) {
        if (pos+3 > u8.length) break;
        fields.push({ num:u8[pos], size:u8[pos+1], type:u8[pos+2] });
        pos += 3;
      }
      if (hasDev) {
        if (pos < u8.length) {
          var nd = u8[pos++];
          pos += nd * 3;
        }
      }
      defs[localNum] = { gnum:gnum, little:little, fields:fields };

    } else {
      var def = defs[localNum];
      if (!def) continue;
      var row = {};
      for (var fi2=0; fi2<def.fields.length; fi2++) {
        var f2 = def.fields[fi2];
        if (pos+f2.size > u8.length) break;
        row[f2.num] = readVal(dv, pos, f2.size, f2.type, def.little);
        pos += f2.size;
      }
      if (def.gnum === 20) {
        records.push(row);
      } else if (def.gnum === 0 && !fileInfo.mfr) {
        fileInfo = { mfr: row[2], prod: row[4] };
      } else if (def.gnum === 23 && !deviceInfo.mfr) {
        deviceInfo = { mfr: row[2], prod: row[4] };
      }
    }
  }

  var mfr = (fileInfo.mfr || deviceInfo.mfr);
  var mfrName = MFR[mfr] || ('Device (mfr#'+mfr+')');

  return { records: records, mfrName: mfrName, mfr: mfr };
}

// ── Align two record sets ──────────────────────────────────────────
function alignRecords(recs1, recs2) {
  function toMap(recs) {
    var m = {};
    recs.forEach(function(r) {
      var ts = r[253];
      if (ts != null) m[ts] = { power: r[7], cadence: r[4], hr: r[3] };
    });
    return m;
  }

  var m1 = toMap(recs1), m2 = toMap(recs2);
  var keys1 = Object.keys(m1).map(Number).sort(function(a,b){return a-b;});
  var keys2 = Object.keys(m2).map(Number).sort(function(a,b){return a-b;});

  var tsStart = Math.max(keys1[0], keys2[0]);
  var tsEnd   = Math.min(keys1[keys1.length-1], keys2[keys2.length-1]);

  var aligned = [];
  var prev1 = {power:0,cadence:0}, prev2 = {power:0,cadence:0};

  for (var ts=tsStart; ts<=tsEnd; ts++) {
    var r1 = m1[ts] || null, r2 = m2[ts] || null;

    if (r1) prev1 = r1; else r1 = prev1;
    if (r2) prev2 = r2; else r2 = prev2;

    aligned.push({
      ts:      ts,
      elapsed: ts - tsStart,
      d1_power:   (r1.power   != null) ? r1.power   : 0,
      d1_cadence: (r1.cadence != null) ? r1.cadence : 0,
      d2_power:   (r2.power   != null) ? r2.power   : 0,
      d2_cadence: (r2.cadence != null) ? r2.cadence : 0,
    });
  }
  return aligned;
}

// ── Pause detection ────────────────────────────────────────────────
function detectPause(aligned) {
  var regions = [];
  var i = 0;
  while (i < aligned.length) {
    var d1z = aligned[i].d1_power === 0;
    var d2z = aligned[i].d2_power === 0;
    if (d1z !== d2z) {
      var start = i, paused = d1z ? 'd1' : 'd2';
      while (i < aligned.length &&
             (aligned[i].d1_power===0) !== (aligned[i].d2_power===0)) i++;
      var dur = i - start;
      if (dur >= 5) regions.push({ start:start, end:i, duration:dur, paused:paused });
    } else { i++; }
  }
  // Only report as a real pause if a single contiguous region is dominant
  // (filter out tiny boundary noise at interval rest transitions)
  return regions.filter(function(r) { return r.duration >= 10; });
}

// ── Averages ───────────────────────────────────────────────────────
function avgNonZero(arr, key) {
  var sum=0, n=0;
  arr.forEach(function(r){ if(r[key]>0){sum+=r[key];n++;} });
  return n>0 ? sum/n : 0;
}

// ── Build intervals ────────────────────────────────────────────────
function buildIntervals(aligned, intervalSec, pauseRegions) {
  var pauseSet = new Set();
  pauseRegions.forEach(function(p){
    for(var i=p.start;i<p.end;i++) pauseSet.add(i);
  });

  var maxElapsed = aligned[aligned.length-1].elapsed;
  var intervals = [];
  var i = 0;
  while (true) {
    var start = i * intervalSec;
    var end   = (i+1) * intervalSec;
    if (start > maxElapsed) break;
    var subset = aligned.filter(function(r,idx){
      return r.elapsed >= start && r.elapsed < end && !pauseSet.has(idx);
    });
    if (!subset.length && start > maxElapsed) break;
    var d1a = avgNonZero(subset, 'd1_power');
    var d2a = avgNonZero(subset, 'd2_power');
    var partial = end > maxElapsed + 1;
    intervals.push({
      label:   formatTime(start) + ' – ' + formatTime(Math.min(end, maxElapsed+1)),
      partial: partial,
      d1_avg:  Math.round(d1a * 10) / 10,
      d2_avg:  Math.round(d2a * 10) / 10,
      diff:    Math.round((d2a - d1a) * 10) / 10
    });
    i++;
    if (start >= maxElapsed) break;
  }
  return intervals;
}

// ── Utilities ──────────────────────────────────────────────────────
function formatTime(s) {
  s = Math.round(s); if (s<0) s=0;
  return Math.floor(s/60) + ':' + ('0'+(s%60)).slice(-2);
}

function showError(msg) {
  var t = document.getElementById('error-toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(function(){ t.style.display='none'; }, 4000);
}

// ── File drop/select handling ──────────────────────────────────────
function handleFile(input, num) {
  var file = input.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.fit')) {
    showError('Please select a .fit file');
    return;
  }
  if (num===1) { state.file1=file; document.getElementById('fn1').textContent=file.name; document.getElementById('dz1').classList.add('loaded'); }
  else         { state.file2=file; document.getElementById('fn2').textContent=file.name; document.getElementById('dz2').classList.add('loaded'); }
  if (state.file1 && state.file2) document.getElementById('btn-analyse').classList.add('ready');
}
window.handleFile = handleFile;

// Drag & drop
['dz1','dz2'].forEach(function(id, idx) {
  var el = document.getElementById(id);
  var num = idx+1;
  el.addEventListener('dragover', function(e){e.preventDefault();el.classList.add('dragover');});
  el.addEventListener('dragleave', function(){el.classList.remove('dragover');});
  el.addEventListener('drop', function(e){
    e.preventDefault(); el.classList.remove('dragover');
    var file = e.dataTransfer.files[0];
    if (!file) return;
    var input = document.getElementById('fi'+num);
    // Set file on the input
    var dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
    handleFile(input, num);
  });
});

// ── Run analysis ───────────────────────────────────────────────────
window.runAnalysis = function() {
  if (!state.file1 || !state.file2) return;

  var ivVal  = parseInt(document.getElementById('interval-value').value) || 15;
  var ivUnit = document.getElementById('interval-unit').value;
  var ivSec  = ivUnit==='minutes' ? ivVal*60 : ivVal;

  // Show processing
  document.getElementById('upload-screen').style.display = 'none';
  var ps = document.getElementById('processing-screen');
  ps.style.display = 'flex';

  function setStep(msg){ document.getElementById('processing-step').textContent = msg; }

  // Read both files asynchronously then process
  function readFile(file) {
    return new Promise(function(resolve,reject){
      var fr = new FileReader();
      fr.onload = function(e){ resolve(e.target.result); };
      fr.onerror = reject;
      fr.readAsArrayBuffer(file);
    });
  }

  setStep('Reading ' + state.file1.name + '…');

  Promise.all([readFile(state.file1), readFile(state.file2)])
    .then(function(buffers) {
      setStep('Parsing Device 1…');
      var parsed1 = parseFIT(buffers[0]);
      setStep('Parsing Device 2…');
      var parsed2 = parseFIT(buffers[1]);

      if (!parsed1.records.length || !parsed2.records.length) {
        throw new Error('Could not extract records from one or both .fit files.');
      }

      setStep('Aligning on common timestamp grid…');
      var aligned = alignRecords(parsed1.records, parsed2.records);

      setStep('Detecting pauses…');
      var pauses = detectPause(aligned);

      setStep('Calculating statistics…');
      var intervalSec = ivSec;
      var intervals = buildIntervals(aligned, intervalSec, pauses);

      var d1avg = avgNonZero(aligned, 'd1_power');
      var d2avg = avgNonZero(aligned, 'd2_power');
      var maxElapsed = aligned[aligned.length-1].elapsed;

      // Derive actual ride date from FIT absolute timestamp
      // FIT epoch = Dec 31 1989 00:00:00 UTC = Unix 631065600
      var FIT_EPOCH = 631065600;
      var firstTs = aligned[0].ts; // absolute FIT timestamp
      var rideUnix = (firstTs + FIT_EPOCH) * 1000;
      var rideDate = new Date(rideUnix);
      var rideDateStr = rideDate.toLocaleDateString('en-AU', { weekday:'short', day:'numeric', month:'short', year:'numeric' });

      state.aligned       = aligned;
      state.intervals     = intervals;
      state.totalDuration = maxElapsed;
      state.dev1Name      = parsed1.mfrName;
      state.dev2Name      = parsed2.mfrName;
      state.pauseDetected = pauses.length > 0;
      state.pauseRegions  = pauses;
      state.d1avg         = Math.round(d1avg*10)/10;
      state.d2avg         = Math.round(d2avg*10)/10;
      state.diffavg       = Math.round((d2avg-d1avg)*10)/10;
      state.intervalSec   = intervalSec;
      state.rideDateStr   = rideDateStr;

      // Extract chart arrays
      state.seconds  = aligned.map(function(r){return r.elapsed;});
      state.d1power  = aligned.map(function(r){return r.d1_power;});
      state.d2power  = aligned.map(function(r){return r.d2_power;});
      state.diffArr  = aligned.map(function(r){return r.d2_power - r.d1_power;});

      // Console summary
      console.log('=== FIT Power Analyser ===');
      console.log('Device 1:', parsed1.mfrName, '| File:', state.file1.name);
      console.log('Device 2:', parsed2.mfrName, '| File:', state.file2.name);
      console.log('Duration:', formatTime(maxElapsed), '('+maxElapsed+'s)');
      console.log('Pause detected:', pauses.length > 0 ? 'YES — '+pauses.length+' region(s)' : 'No — files aligned cleanly');
      console.log('Dev1 avg:', d1avg.toFixed(1)+'W | Dev2 avg:', d2avg.toFixed(1)+'W | Diff:', (d2avg-d1avg).toFixed(1)+'W');

      setStep('Rendering dashboard…');
      // Slight delay so "rendering" message shows
      setTimeout(function(){ renderDashboard(); }, 50);
    })
    .catch(function(err){
      document.getElementById('processing-screen').style.display='none';
      document.getElementById('upload-screen').style.display='flex';
      showError('Error: ' + err.message);
      console.error(err);
    });
};

// ── Render dashboard ───────────────────────────────────────────────
function renderDashboard() {
  var s = state;

  // Header
  var pauseBadge = s.pauseDetected
    ? '<span class="badge badge-yellow">⚠ Pause detected</span>'
    : '<span class="badge badge-green">✓ No pause</span>';
  document.getElementById('dash-title').innerHTML = s.dev1Name + ' vs ' + s.dev2Name + ' ' + pauseBadge;
  document.getElementById('dash-subtitle').textContent =
    s.rideDateStr + ' · ' + formatTime(s.totalDuration) + ' · ' + s.aligned.length + ' data points · Interval: ' + formatIntervalLabel(s.intervalSec);
  document.getElementById('leg1').textContent = s.dev1Name;
  document.getElementById('leg2').textContent = s.dev2Name;

  // Summary cards
  document.getElementById('sc1-label').textContent = s.dev1Name + ' Avg Power';
  document.getElementById('sc2-label').textContent = s.dev2Name + ' Avg Power';
  document.getElementById('sc1-val').textContent  = s.d1avg + ' W';
  document.getElementById('sc2-val').textContent  = s.d2avg + ' W';
  var d3el = document.getElementById('sc3-val');
  var diffSign = s.diffavg >= 0 ? '+' : '';
  d3el.textContent  = diffSign + s.diffavg + ' W';
  d3el.style.color  = s.diffavg > 0 ? 'var(--pink)' : s.diffavg < 0 ? 'var(--green)' : 'var(--text2)';
  document.getElementById('sc3-sub').textContent  = s.diffavg > 0 ? s.dev2Name+' reads higher' : s.diffavg < 0 ? s.dev1Name+' reads higher' : 'Identical';
  document.getElementById('sc4-val').textContent  = formatTime(s.totalDuration);
  document.getElementById('sc4-sub').textContent  = s.pauseDetected ? 'Pause(s) detected' : 'Files aligned cleanly';

  // Zoom stats initial
  document.getElementById('zsl-label').textContent = s.dev1Name + ' Avg';
  document.getElementById('zs2-label').textContent = s.dev2Name + ' Avg';
  document.getElementById('diff-chart-label').textContent =
    'Power Difference (' + s.dev2Name + ' − ' + s.dev1Name + ') · Positive = ' + s.dev2Name + ' reads higher';
  document.getElementById('th-d1').textContent = s.dev1Name + ' Avg (W)';
  document.getElementById('th-d2').textContent = s.dev2Name + ' Avg (W)';
  updateZoomStats(0, s.totalDuration);

  // Table interval controls
  var ivParts = formatIntervalLabel(s.intervalSec).split(' ');
  document.getElementById('tbl-interval-val').value  = ivParts[0];
  document.getElementById('tbl-interval-unit').value = ivParts[1]==='min' ? 'minutes' : 'seconds';

  // Build charts then show dashboard
  var plotBg='#111520', gridCol='#1e2840', textCol='#4a5878', tickCol='#6a7b98';
  var axBase = { gridcolor:gridCol, linecolor:gridCol, tickcolor:gridCol, zeroline:false };

  var tickVals=[], tickText=[];
  for (var t=0; t<=s.totalDuration; t+=300){ tickVals.push(t); tickText.push(formatTime(t)); }

  var xAxis = Object.assign({}, axBase, {
    tickvals:tickVals, ticktext:tickText,
    title:{ text:'Time (MM:SS)', font:{size:10,color:textCol} }
  });

  var mainLayout = {
    paper_bgcolor:plotBg, plot_bgcolor:plotBg, height:420,
    font:{ family:"'JetBrains Mono', monospace", color:tickCol, size:10 },
    xaxis: xAxis,
    yaxis: Object.assign({},axBase,{ title:{text:'Power (W)',font:{size:10,color:textCol}} }),
    hovermode:'x unified',
    hoverlabel:{ bgcolor:'#161b28', bordercolor:'#1e2840', font:{family:"'JetBrains Mono', monospace",size:10,color:'#dde4f0'} },
    legend:{ bgcolor:'rgba(17,21,32,0.85)', bordercolor:'#1e2840', borderwidth:1, font:{size:10} },
    margin:{ t:10, r:20, b:50, l:65 },
    shapes: buildShapes(s.pauseRegions),
    annotations: buildAnnotations(s.pauseRegions)
  };

  var diffLayout = Object.assign({}, mainLayout, {
    height:200,
    yaxis: Object.assign({},axBase,{ title:{text:'Diff (W)',font:{size:10,color:textCol}}, zeroline:true, zerolinecolor:'#263350' }),
    legend:{ visible:false },
    shapes: buildShapes(s.pauseRegions),
    annotations: buildAnnotations(s.pauseRegions)
  });

  var cfg = { responsive:true, displayModeBar:true, modeBarButtonsToRemove:['sendDataToCloud'], displaylogo:false };

  var mainTraces = [
    { x:s.seconds, y:s.d1power, type:'scatter', mode:'lines', name:s.dev1Name,
      line:{color:'#00ff87',width:1.5},
      hovertemplate:'<b style="color:#00ff87">'+s.dev1Name+'</b> %{y:.0f} W<extra></extra>' },
    { x:s.seconds, y:s.d2power, type:'scatter', mode:'lines', name:s.dev2Name,
      line:{color:'#ff3d7f',width:1.5},
      hovertemplate:'<b style="color:#ff3d7f">'+s.dev2Name+'</b> %{y:.0f} W<extra></extra>' }
  ];

  var diffTraces = [
    { x:[s.seconds[0],s.seconds[s.seconds.length-1]], y:[0,0],
      type:'scatter', mode:'lines', line:{color:'#263350',width:1}, hoverinfo:'skip', showlegend:false },
    { x:s.seconds, y:s.diffArr, type:'scatter', mode:'lines', name:'Difference',
      line:{color:'#3d8bff',width:1.5}, fill:'tozeroy', fillcolor:'rgba(61,139,255,0.07)',
      hovertemplate:'<b>Diff</b> %{y:.0f} W<extra></extra>' }
  ];

  var mainEl = document.getElementById('main-chart');
  var diffEl = document.getElementById('diff-chart');

  // Hide processing, show dashboard
  document.getElementById('processing-screen').style.display='none';
  document.getElementById('dashboard-screen').style.display='block';

  // Render charts
  Promise.all([
    Plotly.newPlot(mainEl, mainTraces, mainLayout, cfg),
    Plotly.newPlot(diffEl, diffTraces, diffLayout, cfg)
  ]).then(function(){
    updateZoomStats(0, s.totalDuration);
    renderTable(0);
    attachZoomListeners(mainEl, diffEl);
  });
}

// ── Pause shapes & annotations ─────────────────────────────────────
function buildShapes(pauses) {
  return pauses.map(function(p){
    return {
      type:'rect', xref:'x', yref:'paper',
      x0: state.seconds[p.start] || 0,
      x1: state.seconds[Math.min(p.end, state.seconds.length-1)] || 0,
      y0:0, y1:1,
      fillcolor:'rgba(255,210,63,0.06)',
      line:{ color:'rgba(255,210,63,0.2)', width:1 }
    };
  });
}

function buildAnnotations(pauses) {
  return pauses.map(function(p){
    var midX = ((state.seconds[p.start]||0) + (state.seconds[Math.min(p.end,state.seconds.length-1)]||0)) / 2;
    return {
      x:midX, y:0.96, xref:'x', yref:'paper',
      text:'PAUSE', showarrow:false,
      font:{ size:9, color:'#ffd23f', family:"'JetBrains Mono', monospace" },
      yanchor:'top'
    };
  });
}

// ── Zoom stats ─────────────────────────────────────────────────────
function updateZoomStats(x0, x1) {
  var s = state;
  var d1sum=0, d2sum=0, cnt=0, pts=0, minS=Infinity, maxS=-Infinity;
  for (var i=0; i<s.seconds.length; i++) {
    var sec = s.seconds[i];
    if (sec>=x0 && sec<=x1) {
      pts++;
      if (s.d1power[i]>0 && s.d2power[i]>0) {
        d1sum+=s.d1power[i]; d2sum+=s.d2power[i]; cnt++;
        if (sec<minS) minS=sec; if (sec>maxS) maxS=sec;
      }
    }
  }
  if (cnt===0) return;
  var d1a=d1sum/cnt, d2a=d2sum/cnt, diff=d2a-d1a;
  var full = x0<=0 && x1>=s.totalDuration;
  document.getElementById('zoom-range-label').textContent = full ? 'Full ride' : formatTime(x0)+' → '+formatTime(x1);
  document.getElementById('zs-d1').textContent = d1a.toFixed(1)+' W';
  document.getElementById('zs-d1-sub').textContent = full ? 'full ride' : formatTime(minS)+'–'+formatTime(maxS);
  document.getElementById('zs-d2').textContent = d2a.toFixed(1)+' W';
  document.getElementById('zs-d2-sub').textContent = full ? 'full ride' : formatTime(minS)+'–'+formatTime(maxS);
  var de=document.getElementById('zs-diff');
  de.textContent=(diff>=0?'+':'')+diff.toFixed(1)+' W';
  de.style.color=diff>0?'var(--pink)':diff<0?'var(--green)':'var(--text2)';
  document.getElementById('zs-diff-sub').textContent=diff>0?s.dev2Name+' reads higher':diff<0?s.dev1Name+' reads higher':'Identical';
  document.getElementById('zs-pts').textContent=pts.toLocaleString();
  document.getElementById('zs-time-range').textContent=formatTime(x0)+' → '+formatTime(x1);
}

// ── Zoom event listeners ───────────────────────────────────────────
function attachZoomListeners(mainEl, diffEl) {
  var syncing=false;
  var td=state.totalDuration;

  function getRange(el){
    var l=el.layout;
    return (l&&l.xaxis&&l.xaxis.range)?[l.xaxis.range[0],l.xaxis.range[1]]:[0,td];
  }

  mainEl.on('plotly_relayout',function(ed){
    if(syncing) return;
    var x0,x1;
    if(ed['xaxis.range[0]']!==undefined){x0=ed['xaxis.range[0]'];x1=ed['xaxis.range[1]'];}
    else if(ed['xaxis.autorange']){x0=0;x1=td;}
    else{var r=getRange(mainEl);x0=r[0];x1=r[1];}
    updateZoomStats(x0,x1);
    syncing=true;
    var u=ed['xaxis.autorange']?{'xaxis.autorange':true}:{'xaxis.range[0]':x0,'xaxis.range[1]':x1};
    Plotly.relayout(diffEl,u).then(function(){syncing=false;});
  });

  diffEl.on('plotly_relayout',function(ed){
    if(syncing) return;
    var x0,x1;
    if(ed['xaxis.range[0]']!==undefined){x0=ed['xaxis.range[0]'];x1=ed['xaxis.range[1]'];}
    else if(ed['xaxis.autorange']){x0=0;x1=td;}
    else{var r=getRange(diffEl);x0=r[0];x1=r[1];}
    updateZoomStats(x0,x1);
    syncing=true;
    var u=ed['xaxis.autorange']?{'xaxis.autorange':true}:{'xaxis.range[0]':x0,'xaxis.range[1]':x1};
    Plotly.relayout(mainEl,u).then(function(){syncing=false;});
  });
}

// ── Interval table ─────────────────────────────────────────────────
function renderTable(page) {
  var ivs = state.intervals;
  var start=page*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, ivs.length);
  var rows='';
  for (var i=start; i<end; i++) {
    var iv=ivs[i];
    var pt=iv.partial?'<span class="tag-partial">partial</span>':'';
    var dc=iv.diff>0?'val-pos':iv.diff<0?'val-neg':'';
    var ds=(iv.diff>=0?'+':'')+iv.diff.toFixed(1);
    var d1s=iv.d1_avg>0?iv.d1_avg.toFixed(1):'—';
    var d2s=iv.d2_avg>0?iv.d2_avg.toFixed(1):'—';
    rows+='<tr><td>'+iv.label+pt+'</td>'
         +'<td class="val-green">'+d1s+'</td>'
         +'<td class="val-pink">'+d2s+'</td>'
         +'<td class="'+dc+'">'+(iv.d1_avg>0||iv.d2_avg>0?ds:'—')+'</td></tr>';
  }
  document.getElementById('interval-tbody').innerHTML=rows;
  var tp=Math.ceil(ivs.length/PAGE_SIZE)||1;
  document.getElementById('page-info').textContent='Page '+(page+1)+' of '+tp;
  document.getElementById('btn-prev').disabled=page===0;
  document.getElementById('btn-next').disabled=page>=tp-1;
  state.currentPage=page;
}

window.changePage=function(dir){
  var np=state.currentPage+dir;
  if(np>=0 && np<Math.ceil(state.intervals.length/PAGE_SIZE)) renderTable(np);
};

window.rebuildTable=function(){
  var val=parseInt(document.getElementById('tbl-interval-val').value)||15;
  var unit=document.getElementById('tbl-interval-unit').value;
  var sec=unit==='minutes'?val*60:val;
  state.intervals=buildIntervals(state.aligned, sec, state.pauseRegions);
  state.intervalSec=sec;
  document.getElementById('dash-subtitle').textContent=
    state.rideDateStr + ' · ' + formatTime(state.totalDuration)+' · '+state.aligned.length+' data points · Interval: '+formatIntervalLabel(sec);
  renderTable(0);
};

function formatIntervalLabel(sec){
  if(sec%60===0) return (sec/60)+' min';
  return sec+' sec';
}

// ── Notes counter ──────────────────────────────────────────────────
window.updateNotesCount = function() {
  var ta = document.getElementById('ride-notes');
  document.getElementById('notes-count').textContent = ta.value.length + ' / 4000 chars';
};

// ── Save Report (fully interactive) ───────────────────────────────
window.saveReport = function() {
  var btn = document.getElementById('btn-save');
  btn.classList.add('saving');
  btn.textContent = 'Generating…';

  var s = state;
  var notes = document.getElementById('ride-notes').value.trim();
  var now = new Date();
  var savedDateStr = now.toLocaleDateString('en-AU', { day:'2-digit', month:'short', year:'numeric' });
  var savedTimeStr = now.toLocaleTimeString('en-AU', { hour:'2-digit', minute:'2-digit' });

  var diffSign = s.diffavg >= 0 ? '+' : '';
  var diffCol  = s.diffavg > 0 ? '#ff3d7f' : s.diffavg < 0 ? '#00ff87' : '#8a9bb8';

  var pauseBadgeHtml = s.pauseDetected
    ? '<span style="display:inline-flex;align-items:center;gap:5px;background:rgba(255,210,63,0.1);border:1px solid rgba(255,210,63,0.25);color:#ffd23f;font-size:0.62rem;padding:3px 10px;border-radius:20px;letter-spacing:0.08em;text-transform:uppercase;vertical-align:middle;margin-left:10px;">&#9888; Pause detected</span>'
    : '<span style="display:inline-flex;align-items:center;gap:5px;background:rgba(0,255,135,0.1);border:1px solid rgba(0,255,135,0.25);color:#00ff87;font-size:0.62rem;padding:3px 10px;border-radius:20px;letter-spacing:0.08em;text-transform:uppercase;vertical-align:middle;margin-left:10px;">&#10003; No pause</span>';

  var notesHtml = notes
    ? '<div style="background:#111520;border:1px solid #1e2840;border-radius:10px;padding:18px 20px;margin-bottom:16px;"><div style="font-size:0.6rem;color:#4a5878;text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px;">Ride Notes</div><div style="font-size:0.82rem;color:#dde4f0;line-height:1.7;white-space:pre-wrap;">' + escapeHtml(notes) + '</div></div>'
    : '';

  // Full interval table — all rows, no pagination
  var tableRows = '';
  s.intervals.forEach(function(iv) {
    var pt = iv.partial ? '<span style="display:inline-block;background:rgba(255,210,63,0.12);color:#ffd23f;border:1px solid rgba(255,210,63,0.2);font-size:0.55rem;padding:1px 5px;border-radius:3px;margin-left:5px;text-transform:uppercase;">partial</span>' : '';
    var dc = iv.diff > 0 ? 'color:#ff3d7f' : iv.diff < 0 ? 'color:#00ff87' : 'color:#8a9bb8';
    var ds = (iv.diff >= 0 ? '+' : '') + iv.diff.toFixed(1);
    var d1s = iv.d1_avg > 0 ? iv.d1_avg.toFixed(1) : '&#8212;';
    var d2s = iv.d2_avg > 0 ? iv.d2_avg.toFixed(1) : '&#8212;';
    tableRows += '<tr>'
      + '<td style="padding:8px 14px;border-bottom:1px solid #1e2840;text-align:left;color:#dde4f0;font-size:0.72rem;">' + escapeHtml(iv.label) + pt + '</td>'
      + '<td style="padding:8px 14px;border-bottom:1px solid #1e2840;text-align:right;color:#00ff87;font-weight:500;">' + d1s + '</td>'
      + '<td style="padding:8px 14px;border-bottom:1px solid #1e2840;text-align:right;color:#ff3d7f;font-weight:500;">' + d2s + '</td>'
      + '<td style="padding:8px 14px;border-bottom:1px solid #1e2840;text-align:right;' + dc + ';font-weight:500;">' + ((iv.d1_avg>0||iv.d2_avg>0) ? ds : '&#8212;') + '</td>'
      + '</tr>';
  });

  // Pause overlay shapes/annotations — pre-computed for embedding
  var pauseShapesJson = JSON.stringify(s.pauseRegions.map(function(p) {
    return { type:'rect', xref:'x', yref:'paper',
      x0:s.seconds[p.start]||0, x1:s.seconds[Math.min(p.end,s.seconds.length-1)]||0,
      y0:0, y1:1, fillcolor:'rgba(255,210,63,0.06)',
      line:{color:'rgba(255,210,63,0.2)',width:1} };
  }));
  var pauseAnnotJson = JSON.stringify(s.pauseRegions.map(function(p) {
    var midX = ((s.seconds[p.start]||0)+(s.seconds[Math.min(p.end,s.seconds.length-1)]||0))/2;
    return { x:midX, y:0.96, xref:'x', yref:'paper', text:'PAUSE', showarrow:false,
      font:{size:9,color:'#ffd23f',family:"'JetBrains Mono',monospace"}, yanchor:'top' };
  }));

  // Embed all chart data as a single JSON blob — no re-parsing on open
  var dataJson = JSON.stringify({
    seconds:s.seconds, d1power:s.d1power, d2power:s.d2power, diffArr:s.diffArr,
    dev1Name:s.dev1Name, dev2Name:s.dev2Name,
    d1avg:s.d1avg, d2avg:s.d2avg, diffavg:s.diffavg,
    totalDuration:s.totalDuration, rideDateStr:s.rideDateStr,
    intervalSec:s.intervalSec
  });

  // Build snapshot as array of lines then join — avoids escaping nightmares
  var L = [
    '<!DOCTYPE html>',
    '<html lang="en">',
    '<head>',
    '<meta charset="UTF-8">',
    '<meta name="viewport" content="width=device-width,initial-scale=1">',
    '<title>' + escapeHtml(s.dev1Name) + ' vs ' + escapeHtml(s.dev2Name) + ' \u2014 Power Report</title>',
    '<style>',
    "@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=JetBrains+Mono:wght@300;400;500&display=swap');",
    '*{box-sizing:border-box;margin:0;padding:0}',
    "body{background:#080a0f;color:#dde4f0;font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden}",
    'body::after{content:"";position:fixed;inset:0;pointer-events:none;opacity:.03;background-image:linear-gradient(#1e2840 1px,transparent 1px),linear-gradient(90deg,#1e2840 1px,transparent 1px);background-size:40px 40px;z-index:0}',
    '.wrap{max-width:1300px;margin:0 auto;padding:28px 32px;position:relative;z-index:1}',
    '.nav{display:flex;align-items:center;justify-content:space-between;padding:13px 32px;border-bottom:1px solid #1e2840;background:rgba(8,10,15,.96);position:sticky;top:0;z-index:100}',
    ".nav-brand{font-family:'Barlow Condensed',sans-serif;font-size:1.2rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;display:flex;align-items:center;gap:9px}",
    '.dot{width:7px;height:7px;background:#00ff87;border-radius:50%;box-shadow:0 0 7px #00ff87}',
    '.nav-meta{font-size:.6rem;color:#4a5878;letter-spacing:.1em;text-transform:uppercase}',
    '.zoom-badge-row{display:flex;align-items:center;gap:10px;margin-bottom:7px}',
    '.live-dot{width:6px;height:6px;background:#3d8bff;border-radius:50%;animation:breathe 1.5s infinite;box-shadow:0 0 6px #3d8bff}',
    '@keyframes breathe{0%,100%{opacity:1}50%{opacity:0.3}}',
    '.zoom-label{font-size:.65rem;color:#3d8bff;text-transform:uppercase;letter-spacing:.1em}',
    '.zoom-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:#1e2840;border:1px solid #1e2840;border-radius:10px;overflow:hidden;margin-bottom:16px}',
    '.zoom-stat{background:#161b28;padding:11px 16px;display:flex;flex-direction:column;gap:3px}',
    '.zoom-stat-label{font-size:.6rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em}',
    ".zoom-stat-value{font-family:'Barlow Condensed',sans-serif;font-size:1.3rem;font-weight:700;line-height:1;transition:color .15s}",
    '.zoom-stat-sub{font-size:.6rem;color:#4a5878}',
    '.chart-card{background:#111520;border:1px solid #1e2840;border-radius:12px;padding:16px;margin-bottom:14px}',
    '.chart-label{font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.12em;margin-bottom:10px}',
    '.chart-hint{font-size:.62rem;color:#4a5878;text-align:center;margin-top:8px;letter-spacing:.06em}',
    '@media(max-width:700px){.zoom-stats{grid-template-columns:repeat(2,1fr)}.wrap{padding:16px}}',
    '</style>',
    '</head>',
    '<body>',
    '<nav class="nav">',
    '  <div class="nav-brand"><span class="dot"></span>FIT Power Report</div>',
    '  <span class="nav-meta">Generated ' + savedDateStr + ' \u00b7 ' + savedTimeStr + '</span>',
    '</nav>',
    '<div class="wrap">',
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;flex-wrap:wrap;gap:12px;padding-top:4px;">',
    '  <div>',
    "    <div style=\"font-family:'Barlow Condensed',sans-serif;font-size:clamp(1.6rem,3vw,2.4rem);font-weight:800;letter-spacing:.04em;text-transform:uppercase;line-height:1;\">" + escapeHtml(s.dev1Name) + ' vs ' + escapeHtml(s.dev2Name) + ' ' + pauseBadgeHtml + '</div>',
    '    <div style="color:#8a9bb8;font-size:.72rem;margin-top:8px;letter-spacing:.06em;text-transform:uppercase;">' + escapeHtml(s.rideDateStr) + ' \u00b7 ' + formatTime(s.totalDuration) + ' \u00b7 ' + s.seconds.length + ' data points</div>',
    '  </div>',
    '  <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;">',
    '    <div style="display:flex;align-items:center;gap:7px;font-size:.7rem;color:#8a9bb8;text-transform:uppercase;letter-spacing:.08em;"><div style="width:22px;height:2px;border-radius:2px;background:#00ff87"></div>' + escapeHtml(s.dev1Name) + '</div>',
    '    <div style="display:flex;align-items:center;gap:7px;font-size:.7rem;color:#8a9bb8;text-transform:uppercase;letter-spacing:.08em;"><div style="width:22px;height:2px;border-radius:2px;background:#ff3d7f"></div>' + escapeHtml(s.dev2Name) + '</div>',
    '  </div>',
    '</div>',
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px;margin-bottom:16px;">',
    '  <div style="background:#111520;border:1px solid #1e2840;border-radius:10px;padding:14px 18px;"><div style="font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">' + escapeHtml(s.dev1Name) + ' Avg Power</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:1.6rem;font-weight:700;color:#00ff87;">' + s.d1avg + ' W</div><div style="font-size:.62rem;color:#4a5878;margin-top:4px;">Full ride (excl. zeros)</div></div>',
    '  <div style="background:#111520;border:1px solid #1e2840;border-radius:10px;padding:14px 18px;"><div style="font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">' + escapeHtml(s.dev2Name) + ' Avg Power</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:1.6rem;font-weight:700;color:#ff3d7f;">' + s.d2avg + ' W</div><div style="font-size:.62rem;color:#4a5878;margin-top:4px;">Full ride (excl. zeros)</div></div>',
    '  <div style="background:#111520;border:1px solid #1e2840;border-radius:10px;padding:14px 18px;"><div style="font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Difference (Dev2 \u2212 Dev1)</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:1.6rem;font-weight:700;color:' + diffCol + ';">' + diffSign + s.diffavg + ' W</div><div style="font-size:.62rem;color:#4a5878;margin-top:4px;">' + escapeHtml(s.diffavg>0?s.dev2Name+' reads higher':s.diffavg<0?s.dev1Name+' reads higher':'Identical') + '</div></div>',
    '  <div style="background:#111520;border:1px solid #1e2840;border-radius:10px;padding:14px 18px;"><div style="font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;">Ride Duration</div><div style="font-family:\'Barlow Condensed\',sans-serif;font-size:1.6rem;font-weight:700;color:#3d8bff;">' + formatTime(s.totalDuration) + '</div><div style="font-size:.62rem;color:#4a5878;margin-top:4px;">' + escapeHtml(s.pauseDetected?'Pause(s) detected':'Files aligned cleanly') + '</div></div>',
    '</div>',
    notesHtml,
    '<div class="zoom-badge-row"><div class="live-dot"></div><div class="zoom-label">Live \u2014 <span id="zoom-range-label">Full ride</span></div></div>',
    '<div class="zoom-stats">',
    '  <div class="zoom-stat"><div class="zoom-stat-label">' + escapeHtml(s.dev1Name) + ' Avg</div><div class="zoom-stat-value" style="color:#00ff87" id="zs-d1">' + s.d1avg + ' W</div><div class="zoom-stat-sub" id="zs-d1-sub">full ride</div></div>',
    '  <div class="zoom-stat"><div class="zoom-stat-label">' + escapeHtml(s.dev2Name) + ' Avg</div><div class="zoom-stat-value" style="color:#ff3d7f" id="zs-d2">' + s.d2avg + ' W</div><div class="zoom-stat-sub" id="zs-d2-sub">full ride</div></div>',
    '  <div class="zoom-stat"><div class="zoom-stat-label">Difference (D2 \u2212 D1)</div><div class="zoom-stat-value" id="zs-diff" style="color:' + diffCol + ';">' + diffSign + s.diffavg + ' W</div><div class="zoom-stat-sub" id="zs-diff-sub">' + escapeHtml(s.diffavg>0?s.dev2Name+' reads higher':s.diffavg<0?s.dev1Name+' reads higher':'Identical') + '</div></div>',
    '  <div class="zoom-stat"><div class="zoom-stat-label">Points in View</div><div class="zoom-stat-value" style="color:#3d8bff" id="zs-pts">' + s.seconds.length.toLocaleString() + '</div><div class="zoom-stat-sub" id="zs-time-range">0:00 \u2192 ' + formatTime(s.totalDuration) + '</div></div>',
    '</div>',
    '<div class="chart-card"><div class="chart-label">Power Output \u2014 zoom &amp; pan to interrogate</div><div id="main-chart"></div><div class="chart-hint">&#9635; Box-select to zoom \u00b7 Scroll to zoom \u00b7 Click legend to toggle \u00b7 Double-click to reset</div></div>',
    '<div class="chart-card"><div class="chart-label">Power Difference (' + escapeHtml(s.dev2Name) + ' \u2212 ' + escapeHtml(s.dev1Name) + ')</div><div id="diff-chart"></div></div>',
    '<div style="background:#111520;border:1px solid #1e2840;border-radius:12px;overflow:hidden;margin-bottom:16px;">',
    '  <div style="padding:12px 18px;border-bottom:1px solid #1e2840;background:#161b28;font-size:.62rem;color:#4a5878;text-transform:uppercase;letter-spacing:.1em;">Interval Summary \u00b7 ' + escapeHtml(formatIntervalLabel(s.intervalSec)) + ' blocks</div>',
    '  <div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:.76rem;">',
    '    <thead><tr>',
    '      <th style="background:#161b28;color:#4a5878;text-transform:uppercase;letter-spacing:.08em;font-size:.6rem;padding:10px 14px;text-align:left;font-weight:400;border-bottom:1px solid #1e2840;">Interval</th>',
    '      <th style="background:#161b28;color:#4a5878;text-transform:uppercase;letter-spacing:.08em;font-size:.6rem;padding:10px 14px;text-align:right;font-weight:400;border-bottom:1px solid #1e2840;">' + escapeHtml(s.dev1Name) + ' Avg (W)</th>',
    '      <th style="background:#161b28;color:#4a5878;text-transform:uppercase;letter-spacing:.08em;font-size:.6rem;padding:10px 14px;text-align:right;font-weight:400;border-bottom:1px solid #1e2840;">' + escapeHtml(s.dev2Name) + ' Avg (W)</th>',
    '      <th style="background:#161b28;color:#4a5878;text-transform:uppercase;letter-spacing:.08em;font-size:.6rem;padding:10px 14px;text-align:right;font-weight:400;border-bottom:1px solid #1e2840;">Difference (W)</th>',
    '    </tr></thead>',
    '    <tbody>' + tableRows + '</tbody>',
    '  </table></div>',
    '</div>',
    '</div>', // /wrap
    // Embedded data — loaded before Plotly so it's ready instantly
    '<script>var __D=' + dataJson + ';var __PS=' + pauseShapesJson + ';var __PA=' + pauseAnnotJson + ';<\/script>',
    '<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"><\/script>',
    '<script>',
    '(function(){',
    "  var D=__D,PS=__PS,PA=__PA;",
    "  function fmt(s){s=Math.round(s);if(s<0)s=0;return Math.floor(s/60)+':'+(('0'+(s%60)).slice(-2));}",
    '  function updateStats(x0,x1){',
    '    var d1s=0,d2s=0,n=0,pts=0,lo=Infinity,hi=-Infinity;',
    '    for(var i=0;i<D.seconds.length;i++){var s=D.seconds[i];if(s>=x0&&s<=x1){pts++;if(D.d1power[i]>0&&D.d2power[i]>0){d1s+=D.d1power[i];d2s+=D.d2power[i];n++;if(s<lo)lo=s;if(s>hi)hi=s;}}}',
    '    if(!n)return;',
    '    var d1a=d1s/n,d2a=d2s/n,df=d2a-d1a,full=x0<=0&&x1>=D.totalDuration;',
    "    document.getElementById('zoom-range-label').textContent=full?'Full ride':fmt(x0)+' \u2192 '+fmt(x1);",
    "    document.getElementById('zs-d1').textContent=d1a.toFixed(1)+' W';",
    "    document.getElementById('zs-d1-sub').textContent=full?'full ride':fmt(lo)+'\u2013'+fmt(hi);",
    "    document.getElementById('zs-d2').textContent=d2a.toFixed(1)+' W';",
    "    document.getElementById('zs-d2-sub').textContent=full?'full ride':fmt(lo)+'\u2013'+fmt(hi);",
    "    var de=document.getElementById('zs-diff');",
    "    de.textContent=(df>=0?'+':'')+df.toFixed(1)+' W';de.style.color=df>0?'#ff3d7f':df<0?'#00ff87':'#8a9bb8';",
    "    document.getElementById('zs-diff-sub').textContent=df>0?D.dev2Name+' reads higher':df<0?D.dev1Name+' reads higher':'Identical';",
    "    document.getElementById('zs-pts').textContent=pts.toLocaleString();",
    "    document.getElementById('zs-time-range').textContent=fmt(x0)+' \u2192 '+fmt(x1);",
    '  }',
    "  var bg='#111520',gc='#1e2840',tc='#4a5878',kc='#6a7b98';",
    "  var ax={gridcolor:gc,linecolor:gc,tickcolor:gc,zeroline:false};",
    '  var tv=[],tt=[];for(var t=0;t<=D.totalDuration;t+=300){tv.push(t);tt.push(fmt(t));}',
    "  var xa=Object.assign({},ax,{tickvals:tv,ticktext:tt,title:{text:'Time (MM:SS)',font:{size:10,color:tc}}});",
    "  var ml={paper_bgcolor:bg,plot_bgcolor:bg,height:420,font:{family:\"'JetBrains Mono',monospace\",color:kc,size:10},",
    "    xaxis:xa,yaxis:Object.assign({},ax,{title:{text:'Power (W)',font:{size:10,color:tc}}}),",
    "    hovermode:'x unified',hoverlabel:{bgcolor:'#161b28',bordercolor:'#1e2840',font:{family:\"'JetBrains Mono',monospace\",size:10,color:'#dde4f0'}},",
    "    legend:{bgcolor:'rgba(17,21,32,0.85)',bordercolor:'#1e2840',borderwidth:1,font:{size:10}},",
    '    margin:{t:10,r:20,b:50,l:65},shapes:PS,annotations:PA};',
    "  var dl=Object.assign({},ml,{height:200,yaxis:Object.assign({},ax,{title:{text:'Diff (W)',font:{size:10,color:tc}},zeroline:true,zerolinecolor:'#263350'}),legend:{visible:false},shapes:PS,annotations:PA});",
    "  var cfg={responsive:true,displayModeBar:true,modeBarButtonsToRemove:['sendDataToCloud'],displaylogo:false};",
    '  var mt=[',
    "    {x:D.seconds,y:D.d1power,type:'scatter',mode:'lines',name:D.dev1Name,line:{color:'#00ff87',width:1.5},hovertemplate:'<b style=\"color:#00ff87\">'+D.dev1Name+'</b> %{y:.0f} W<extra></extra>'},",
    "    {x:D.seconds,y:D.d2power,type:'scatter',mode:'lines',name:D.dev2Name,line:{color:'#ff3d7f',width:1.5},hovertemplate:'<b style=\"color:#ff3d7f\">'+D.dev2Name+'</b> %{y:.0f} W<extra></extra>'}",
    '  ];',
    '  var dt=[',
    "    {x:[D.seconds[0],D.seconds[D.seconds.length-1]],y:[0,0],type:'scatter',mode:'lines',line:{color:'#263350',width:1},hoverinfo:'skip',showlegend:false},",
    "    {x:D.seconds,y:D.diffArr,type:'scatter',mode:'lines',name:'Difference',line:{color:'#3d8bff',width:1.5},fill:'tozeroy',fillcolor:'rgba(61,139,255,0.07)',hovertemplate:'<b>Diff</b> %{y:.0f} W<extra></extra>'}",
    '  ];',
    "  var me=document.getElementById('main-chart'),de2=document.getElementById('diff-chart');",
    '  Promise.all([Plotly.newPlot(me,mt,ml,cfg),Plotly.newPlot(de2,dt,dl,cfg)]).then(function(){',
    '    updateStats(0,D.totalDuration);',
    '    var sy=false;',
    "    function gr(el){var l=el.layout;return(l&&l.xaxis&&l.xaxis.range)?[l.xaxis.range[0],l.xaxis.range[1]]:[0,D.totalDuration];}",
    "    me.on('plotly_relayout',function(ed){",
    "      if(sy)return;var x0,x1;",
    "      if(ed['xaxis.range[0]']!==undefined){x0=ed['xaxis.range[0]'];x1=ed['xaxis.range[1]'];}",
    "      else if(ed['xaxis.autorange']){x0=0;x1=D.totalDuration;}",
    '      else{var r=gr(me);x0=r[0];x1=r[1];}',
    '      updateStats(x0,x1);sy=true;',
    "      var u=ed['xaxis.autorange']?{'xaxis.autorange':true}:{'xaxis.range[0]':x0,'xaxis.range[1]':x1};",
    '      Plotly.relayout(de2,u).then(function(){sy=false;});',
    '    });',
    "    de2.on('plotly_relayout',function(ed){",
    "      if(sy)return;var x0,x1;",
    "      if(ed['xaxis.range[0]']!==undefined){x0=ed['xaxis.range[0]'];x1=ed['xaxis.range[1]'];}",
    "      else if(ed['xaxis.autorange']){x0=0;x1=D.totalDuration;}",
    '      else{var r=gr(de2);x0=r[0];x1=r[1];}',
    '      updateStats(x0,x1);sy=true;',
    "      var u=ed['xaxis.autorange']?{'xaxis.autorange':true}:{'xaxis.range[0]':x0,'xaxis.range[1]':x1};",
    '      Plotly.relayout(me,u).then(function(){sy=false;});',
    '    });',
    '  });',
    '})();',
    '<\/script>',
    '</body>',
    '</html>'
  ];

  // Assemble snapshot
  var snapshotHtml = L.join('\n');

  // Trigger download
  var blob = new Blob([snapshotHtml], { type: 'text/html;charset=utf-8' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  var safeD1  = s.dev1Name.replace(/[^a-z0-9]/gi,'_');
  var safeD2  = s.dev2Name.replace(/[^a-z0-9]/gi,'_');
  var fileTs  = now.toISOString().slice(0,10);
  a.href      = url;
  a.download  = 'power-report_' + safeD1 + '_vs_' + safeD2 + '_' + fileTs + '.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // Restore button & show toast
  btn.classList.remove('saving');
  btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.5 13H2.5C1.948 13 1.5 12.552 1.5 12V2C1.5 1.448 1.948 1 2.5 1H9.5L12.5 4V12C12.5 12.552 12.052 13 11.5 13Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 13V8.5H4.5V13" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.5 1V4.5H8.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg> Save Report';
  var toast = document.getElementById('save-toast');
  toast.style.display = 'block';
  setTimeout(function(){ toast.style.display = 'none'; }, 3500);
};
// ── HTML escaper ───────────────────────────────────────────────────
function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// ── Reset ──────────────────────────────────────────────────────────
window.resetApp=function(){
  state.file1=null; state.file2=null;
  document.getElementById('fi1').value='';
  document.getElementById('fi2').value='';
  document.getElementById('fn1').textContent='';
  document.getElementById('fn2').textContent='';
  document.getElementById('dz1').classList.remove('loaded');
  document.getElementById('dz2').classList.remove('loaded');
  document.getElementById('btn-analyse').classList.remove('ready');
  document.getElementById('ride-notes').value='';
  document.getElementById('notes-count').textContent='0 chars';
  document.getElementById('dashboard-screen').style.display='none';
  document.getElementById('upload-screen').style.display='flex';
  // Purge plotly
  try{ Plotly.purge('main-chart'); Plotly.purge('diff-chart'); }catch(e){}
};

})();
</script>
</body>
</html>
